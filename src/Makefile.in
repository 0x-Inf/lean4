# Copyright (c) 2018 Simon Hudon. All rights reserved.
# Released under Apache 2.0 license as described in the file LICENSE.
# Authors: Simon Hudon, Sebastian Ullrich, Leonardo de Moura
SRCS = $(shell find Init -name '*.lean')
DEPS = $(addprefix $(OUT)/temp/,$(SRCS:.lean=.depend))
OPTS = @LEAN_EXTRA_MAKE_OPTS@
STAGE0_DIR = ../stage0
ifndef OUT
$(error "`OUT` must be set (use cmake)")
endif
export LEAN_PATH=Init=$(OUT)/lean/Init
OBJS = $(addprefix $(OUT)/lean/, $(SRCS:.lean=.olean))
# ensure deterministic ordering
CS_CORE=$(sort $(SRCS:.lean=.c))

SHELL = /usr/bin/env bash -eo pipefail

.PHONY: all clean

all: $(OBJS) $(OUT)/libleanstdlib.a

depends: $(DEPS)

$(OUT)/lean/Init:
	@mkdir -p "$@"

$(OUT)/temp/%.depend: %.lean | $(OUT)/lean/Init
	@mkdir -p "$(OUT)/temp/$(*D)"
# use separate assignment to ensure failure propagation
# convert file separators and newlines on Windows
	@deps=`lean --deps $< | sed 's!\\\\!/!g;s/\\r//'`; echo $(OUT)/lean/$(<:.lean=.olean): $$deps > $@

$(OUT)/lean/%.olean: %.lean $(OUT)/temp/%.depend $(MORE_DEPS)
	@echo "[    ] Building $<"
	@mkdir -p $(OUT)/lean/$(*D)
	lean $(OPTS) -o "$@" --c="$(OUT)/temp/$*.c.tmp" $<
# create the .c file atomically
	mv "$(OUT)/temp/$*.c.tmp" "$(OUT)/temp/$*.c"
# make sure the .olean file is newer than the .depend file to prevent infinite make cycles
	@touch $@

$(OUT)/temp/%.c: $(OUT)/lean/%.olean
	@

$(OUT)/temp/%.o: $(OUT)/temp/%.c
	@echo "[    ] Building $<"
	@mkdir -p "$(@D)"
	leanc -c -o $@ $< $(LEANC_OPTS)

$(OUT)/libleanstdlib.a: $(addprefix $(OUT)/temp/,$(SRCS:.lean=.o))
	@rm -f $@
	@ar rcs $@ $^

update-stage0:
	-rm -r $(STAGE0_DIR)
	-mkdir -p $(STAGE0_DIR)/stdlib
	for f in $(SRCS:.lean=.c); do mkdir -p `dirname $(STAGE0_DIR)/stdlib/$$f`; cp $(OUT)/$$f $(STAGE0_DIR)/stdlib/$$f; done
	echo "add_library (stage0 OBJECT $(CS_CORE))" > $(STAGE0_DIR)/stdlib/CMakeLists.txt
# don't copy untracked crap
	git ls-files -z . | xargs -0 -I '{}' bash -c 'mkdir -p `dirname ../stage0/src/{}` && cp {} ../stage0/src/{}'
	-git add $(STAGE0_DIR)

.PRECIOUS: %.depend $(OUT)/temp/%.c

include $(DEPS)
