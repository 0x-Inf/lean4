#!/usr/bin/env bash
# Lean compiler
#
# A simple wrapper around a C compiler. Defaults to the compiler Lean was built with,
# which can be overridden with the environment variable `LEAN_CC`. All parameters are passed
# as-is to the wrapped compiler.
#
# Interesting options:
# * `-U LEAN_MULTI_THREAD` can be used to optimize programs not making use of multi-threading

set -e
bindir=$(dirname $0)

# link to C++ part of Lean, Lean part of Lean, C++ stdlib, C math library (`sin` etc.)
# NOTE: leanstatic and leanstdlib are cyclically dependent
linker_flags="-lleanstatic -lleanstdlib -lleanstatic -lleanstdlib -lstdc++ -lm"
for arg in "$@"; do
    [[ $arg == "-shared" ]] && linker_flags="$linker_flags @LEANC_SHARED_LINKER_FLAGS@"
done

# Check C compiler
for cc in $LEAN_CC @CMAKE_C_COMPILER@ /usr/bin/gcc; do
    if [ -f $cc ] || command -v $cc; then
        export LEAN_CC=$cc && break
    fi
done
[ -f $LEAN_CC ] || command -v $LEAN_CC || error "no suitable C compiler found!"

@CMAKE_C_COMPILER_LAUNCHER@ $LEAN_CC -D LEAN_MULTI_THREAD "-I$bindir/../src" "-I$bindir/../include" "$@" "-L$bindir" "-L$bindir/../lib" $linker_flags -lgmp @LEANC_EXTRA_FLAGS@ -Wno-unused-command-line-argument
